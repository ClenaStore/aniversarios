<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>Bazar • Produtos Usados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="description" content="Bazar de usados — stories, produtos, favoritos e contato por WhatsApp." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0f18; --surface:#0f172a; --card:#111827; --ink:#e6edf6; --muted:#93a3b8; --line:#1f2937;
      --brand:#16a34a; --brand-2:#22c55e; --danger:#ef4444; --radius:16px; --shadow:0 10px 30px rgba(2,6,23,.35);
      --overlay:rgba(0,0,0,.9); --heart:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f5f7fb; --surface:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
             --brand:#16a34a; --brand-2:#22c55e; --shadow:0 10px 24px rgba(15,23,42,.08); --overlay:rgba(0,0,0,.92); }
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;overscroll-behavior:none}
    ::-webkit-scrollbar{width:0;height:0} *{scrollbar-width:none}

    /* Header com busca e coração */
    header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0)),var(--surface);
      border-bottom:1px solid var(--line); padding:10px 14px;
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
      backdrop-filter:saturate(120%) blur(6px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand-logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(120% 120% at 20% 20%, var(--brand-2), var(--brand))}
    .brand h1{font-size:16px;margin:0}
    .tag{font-size:12px;color:var(--muted)}
    .container{max-width:1200px;margin:0 auto;padding:14px}

    .top-tools{display:flex; align-items:center; gap:8px; justify-content:flex-end}
    .search-wrap{
      display:flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--line);
      background:var(--surface); border-radius:12px; min-width:180px; max-width:420px; flex:1;
    }
    .search{flex:1; background:transparent; border:0; outline:0; color:var(--ink); font-size:14px}
    .heart-btn{
      position:relative; width:40px; height:40px; border-radius:12px; border:1px solid var(--line);
      display:grid; place-items:center; background:var(--surface); cursor:pointer;
    }
    .heart-btn.active{ outline:2px solid rgba(239,68,68,.35) }
    .badge{
      position:absolute; top:-6px; right:-6px; background:var(--heart); color:#fff; font-weight:800;
      width:18px; height:18px; border-radius:999px; font-size:11px; display:grid; place-items:center;
      box-shadow:0 4px 10px rgba(239,68,68,.4);
    }

    /* Stories strip */
    .stories-strip{display:flex; gap:10px; overflow-x:auto; padding:8px 2px 2px; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory;}
    .story-pill{ flex:0 0 auto; width:76px; scroll-snap-align:start; text-align:center; cursor:pointer; }
    .story-ring{
      width:76px;height:76px;border-radius:50%;
      padding:3px; background:
        radial-gradient(closest-side, #0000 70%, #0000 0) padding-box,
        conic-gradient(from 0deg, var(--brand-2), var(--brand)) border-box;
      display:grid; place-items:center;
    }
    .story-thumb{ width:68px;height:68px;border-radius:50%; object-fit:cover; border:2px solid var(--bg) }
    .story-title{font-size:12px;margin-top:6px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Grid */
    .grid{display:grid; gap:14px; margin-top:12px; grid-template-columns:repeat(2, 1fr)}
    @media (min-width:768px){ .grid{ grid-template-columns:repeat(4, 1fr) } }
    @media (min-width:1200px){ .grid{ grid-template-columns:repeat(6, 1fr) } }

    .card{
      position:relative; display:flex; flex-direction:column; overflow:hidden; border-radius:16px;
      background:var(--card); border:1px solid var(--line); box-shadow:var(--shadow);
      transition:transform .2s, border-color .2s ease;
    }
    .card:hover{ transform:translateY(-2px); border-color:rgba(34,197,94,.45) }
    .thumb{ aspect-ratio:4/3; width:100%; object-fit:cover; display:block; background:#0b1020 }
    .content{ padding:12px }
    .title{font-size:14px; font-weight:800; margin:0 0 6px; line-height:1.25}
    .price{font-size:15px; font-weight:800; color:var(--brand); margin-bottom:6px}
    .desc{font-size:12px; color:var(--muted); line-height:1.45; margin:0 0 10px; min-height:2.8em; overflow:hidden}
    .pill{position:absolute; bottom:10px; right:10px; font-size:11px; color:var(--muted); padding:6px 8px; border:1px dashed var(--line); border-radius:999px; background:rgba(0,0,0,.2)}

    /* Favoritar */
    .fav{
      position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:999px;
      display:grid; place-items:center; background:rgba(0,0,0,.35); color:#fff; cursor:pointer; border:1px solid rgba(255,255,255,.2);
    }
    .fav .fill{ fill:transparent; stroke:#fff; stroke-width:1.5 }
    .fav.active .fill{ fill:var(--heart); stroke:var(--heart) }

    footer{color:var(--muted); font-size:12px; text-align:center; padding:24px 12px}
    .list-meta{margin:6px 2px 0; font-size:12px; color:var(--muted)}

    /* Overlays fullscreen (stories e detalhes) */
    .overlay{position:fixed; inset:0; z-index:9999; background:var(--overlay); display:none; align-items:center; justify-content:center; width:100vw; height:100svh; -webkit-backdrop-filter:blur(2px); backdrop-filter:blur(2px)}
    .overlay.open{ display:flex }

    /* Story viewer */
    .story-viewer{position:relative; width:min(100vw, 420px); height:100svh; background:#000; overflow:hidden; display:flex; align-items:center; justify-content:center}
    .story-img{position:absolute; inset:0; object-fit:cover; width:100%; height:100%; opacity:0; transition:opacity .8s ease}
    .story-img.active{ opacity:1 }
    .progress{position:absolute; top:calc(env(safe-area-inset-top) + 8px); left:8px; right:8px; display:flex; gap:5px; z-index:3}
    .bar{ flex:1; height:3px; border-radius:999px; background:rgba(255,255,255,.25); overflow:hidden }
    .bar .fill{ width:0%; height:100%; background:#fff; transition:width linear }
    .controls{ position:absolute; inset:0; display:flex; z-index:2 }
    .tap-left,.tap-right{ flex:1 1 50% }
    .close-btn{ position:absolute; top:calc(env(safe-area-inset-top) + 10px); right:10px; z-index:4; width:36px;height:36px;border-radius:999px;border:1px solid rgba(255,255,255,.2); display:grid;place-items:center;background:rgba(0,0,0,.35); color:#fff; cursor:pointer }

    /* Tag do item + composer */
    .story-tag{position:absolute; left:12px; bottom:82px; z-index:4; background:rgba(0,0,0,.55); color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,.15); max-width:90%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .composer{position:absolute; left:0; right:0; bottom:0; z-index:5; padding:12px 10px calc(10px + env(safe-area-inset-bottom)); background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55) 40%, rgba(0,0,0,.85)); display:flex; gap:8px; align-items:center}
    .composer input{flex:1; border:1px solid rgba(255,255,255,.25); background:rgba(0,0,0,.35); color:#fff; border-radius:12px; padding:10px 12px; font-size:14px; outline:none}
    .composer button{min-width:120px; appearance:none; border:0; border-radius:12px; padding:10px 12px; cursor:pointer; font-weight:800; font-size:12px; display:inline-flex; align-items:center; justify-content:center; background:linear-gradient(180deg,var(--brand-2),var(--brand)); color:#fff; box-shadow:0 10px 20px rgba(34,197,94,.22), inset 0 -2px 0 rgba(0,0,0,.2)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <div>
        <h1>Bazar</h1>
        <div class="tag" id="today"></div>
      </div>
    </div>

    <!-- Busca + coração no topo -->
    <div class="top-tools">
      <div class="search-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M11 19a8 8 0 1 1 5.293-14.293A8 8 0 0 1 11 19zm10 3-6-6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input class="search" id="searchTop" type="search" placeholder="Buscar..." />
      </div>
      <button id="heartTop" class="heart-btn" title="Mostrar apenas favoritos">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
          <path class="stroke" d="M12.1 20.3s-7.6-4.4-9.2-9.3C1.9 6.8 5 4.1 8 5.1c1.5.5 2.7 1.8 4 4 1.3-2.2 2.5-3.5 4-4 3-.9 6.1 1.7 5.1 5.9-1.5 4.9-9.1 9.3-9.1 9.3z" fill="none" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        <span id="favCount" class="badge" style="display:none">0</span>
      </button>
    </div>

    <div></div><!-- spacer -->
  </header>

  <main class="container">
    <!-- STORIES (vêm da planilha) -->
    <section aria-label="Stories">
      <div id="storiesStrip" class="stories-strip"></div>
    </section>

    <!-- Meta da lista -->
    <div class="list-meta"><span id="count"></span></div>

    <!-- GRID -->
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <footer>
    © <span id="year"></span> Bazar • Feito com ❤️ | Estoque sujeito a confirmação.
  </footer>

    <!-- OVERLAY: STORIES -->
    <div id="storiesOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Stories">
      <div class="story-viewer" id="storyViewer">
        <div class="progress" id="storyProgress"></div>
        <div class="controls">
          <div class="tap-left" id="tapLeft"></div>
          <div class="tap-right" id="tapRight"></div>
        </div>
        <div class="story-tag" id="storyTag"></div>
        <div class="composer">
          <input id="storyMsg" type="text" maxlength="160" placeholder="Escreva sua mensagem..." />
          <button id="storySend">Enviar</button>
        </div>
        <button class="close-btn" id="closeStories" aria-label="Fechar stories">✕</button>
      </div>
    </div>

  <script>
    /* =================== CONFIG =================== */
    // 1) Troque pelo seu endpoint Google Apps Script (publicado como Web App)
    //   O endpoint deve responder a GET ?acao=listar com:
    //   {
    //     status:"ok",
    //     produtos:[{id,nome,preco,descricao,foto,story?}],
    //     stories:[{grupo, thumb, slides:[productId OU {productId,src}] }]
    //   }
    const URL_API = "https://script.google.com/macros/s/AKfycbyVUcV4Z9x3tQZy4z0SDg37lTCy0aHcjoyOeVQsQU4ClJxrMQhxYEwwLqATWGK27Wv4aQ/exec"; // <-- TROQUE
    const WHATSAPP_NUMBER = "5571999999999"; // <-- TROQUE (somente dígitos, DDI+DDD)

    /* =================== ESTADO =================== */
    let PRODUCTS = [];     // [{id, nome, preco, descricao, foto, story?}]
    let STORIES  = [];     // [{id,title,thumb,slides:[{productId,src}]}]
    let FILTER_FAVS_ONLY = false;
    let FAVORITES = new Set(JSON.parse(localStorage.getItem("bazar_favs") || "[]"));

    /* =================== UTIL =================== */
    const fmtBRL = (v) => {
      const n = typeof v === "number" ? v : parseFloat(String(v).replace(/\./g, "").replace(",", "."));
      return isNaN(n) ? "-" : n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"});
    };
    const pageLink = (id) => location.origin + location.pathname + "#" + id;
    const saveFavs = () => localStorage.setItem("bazar_favs", JSON.stringify([...FAVORITES]));
    const isFav = (id) => FAVORITES.has(id);

    // Bloqueia rolagem do fundo durante overlays
    let scrollPos = 0;
    function lockBody(){
      scrollPos = window.scrollY || document.documentElement.scrollTop;
      document.documentElement.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollPos}px`;
      document.body.style.width = '100%';
    }
    function unlockBody(){
      document.documentElement.style.overflow = '';
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      window.scrollTo(0, scrollPos);
    }

    /* =================== BUSCA DADOS (GAS) =================== */
    async function loadData(){
      const res = await fetch(`${URL_API}?acao=listar`, {cache:"no-store"});
      const data = await res.json();
      if(data.status !== "ok") throw new Error(data.msg || "Resposta inválida");

      // Normaliza produtos
      PRODUCTS = (data.produtos || []).map(p => ({
        id: String(p.id || p.ID || p.Nome).toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,""),
        nome: p.nome || p.Nome || "Produto",
        preco: p.preco ?? p.Preco ?? p.Valor ?? 0,
        descricao: p.descricao || p.Descricao || "",
        foto: p.foto || p.Foto || "",
        story: p.story || p.StoryGrupo || null
      }));

      // Normaliza stories
      if(Array.isArray(data.stories) && data.stories.length){
        STORIES = data.stories.map((g,i)=>{
          const title = g.grupo || g.title || `Stories ${i+1}`;
          const normalizedSlides = (g.slides || []).map(s=>{
            if(typeof s === "string"){
              const prod = PRODUCTS.find(p=>p.id===s);
              return prod ? {productId: prod.id, src: prod.foto} : null;
            }else{
              const pid = s.productId || s.id;
              const prod = PRODUCTS.find(p=>p.id===pid);
              const src = s.src || (prod ? prod.foto : "");
              return prod ? {productId: prod.id, src} : null;
            }
          }).filter(Boolean);
          const thumb = g.thumb || (normalizedSlides[0]?.src || "");
          return { id: title.toLowerCase().replace(/\s+/g,"-"), title, thumb, slides: normalizedSlides };
        }).filter(s=>s.slides.length);
      }else{
        // Fallback: agrupa por campo "story" dos produtos (se vier assim)
        const groups = {};
        for(const p of PRODUCTS){
          const g = p.story || "Destaques";
          groups[g] ??= [];
          groups[g].push({productId: p.id, src: p.foto});
        }
        STORIES = Object.entries(groups).map(([g,slides])=>({
          id: g.toLowerCase().replace(/\s+/g,"-"), title:g, thumb: slides[0]?.src || "", slides
        }));
      }
    }

    /* =================== STORIES STRIP =================== */
    const storiesStrip = document.getElementById("storiesStrip");
    function renderStories(){
      storiesStrip.innerHTML = "";
      for(const st of STORIES){
        const el = document.createElement("div");
        el.className = "story-pill";
        el.innerHTML = `
          <div class="story-ring">
            <img class="story-thumb" src="${st.thumb}" alt="${st.title}" loading="lazy" />
          </div>
          <div class="story-title">${st.title}</div>
        `;
        el.addEventListener("click", ()=> openStories(st));
        storiesStrip.appendChild(el);
      }
    }

    /* =================== STORY VIEWER =================== */
    const storiesOverlay = document.getElementById("storiesOverlay");
    const storyViewer   = document.getElementById("storyViewer");
    const storyProgress = document.getElementById("storyProgress");
    const storyTag      = document.getElementById("storyTag");
    const storyMsg      = document.getElementById("storyMsg");
    const storySend     = document.getElementById("storySend");
    const closeStories  = document.getElementById("closeStories");
    const tapLeft  = document.getElementById("tapLeft");
    const tapRight = document.getElementById("tapRight");
    const DURATION_MS = 7000;

    let currentStory = null;
    let currentIndex = 0;
    let timer = null;

    function clearViewer(){
      [...storyViewer.querySelectorAll("img.story-img")].forEach(n=>n.remove());
      storyProgress.innerHTML = "";
      storyMsg.value = "";
      if(timer){ clearTimeout(timer); timer = null; }
    }

    function productById(id){ return PRODUCTS.find(p=>p.id===id) }

    function labelCurrent(){
      const slide = currentStory.slides[currentIndex];
      const prod  = productById(slide.productId);
      storyTag.textContent = prod ? prod.nome : "";
    }

    function openStories(story){
      clearViewer();
      currentStory = story;
      currentIndex = 0;

      // cria imagens e barras
      currentStory.slides.forEach((sl, i)=>{
        const img = document.createElement("img");
        img.className = "story-img" + (i===0 ? " active":"");
        img.src = sl.src;
        img.alt = `${story.title} • ${i+1}/${currentStory.slides.length}`;
        storyViewer.appendChild(img);

        const bar = document.createElement("div");
        bar.className = "bar";
        const fill = document.createElement("div");
        fill.className = "fill";
        bar.appendChild(fill);
        storyProgress.appendChild(bar);
      });

      // botão enviar dentro do story
      storySend.onclick = ()=>{
        const slide = currentStory.slides[currentIndex];
        const prod  = productById(slide.productId);
        if(!prod) return;
        const msgLines = [];
        const custom = storyMsg.value.trim();
        if(custom) msgLines.push(`Mensagem: ${custom}`);
        msgLines.push(`Item: ${prod.nome}`);
        msgLines.push(`Link: ${pageLink(prod.id)}`);
        const txt = encodeURIComponent(msgLines.join("\n"));
        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${txt}`, "_blank", "noopener");
      };

      storiesOverlay.classList.add("open");
      lockBody();
      runStep();
      labelCurrent();
    }

    function runStep(){
      const imgs  = [...storyViewer.querySelectorAll(".story-img")];
      const fills = [...storyProgress.querySelectorAll(".fill")];

      imgs.forEach((n,i)=> n.classList.toggle("active", i===currentIndex));
      fills.forEach((f,i)=>{ f.style.transition="none"; f.style.width = i < currentIndex ? "100%" : "0%" });

      requestAnimationFrame(()=>{
        const f = fills[currentIndex];
        if(f){ f.style.transition = `width ${DURATION_MS}ms linear`; f.style.width = "100%" }
      });

      if(timer) clearTimeout(timer);
      timer = setTimeout(()=> nextStory(), DURATION_MS);
    }

    function nextStory(){
      if(currentIndex < currentStory.slides.length - 1){
        currentIndex++; runStep(); labelCurrent();
      }else{
        closeStoriesOverlay();
      }
    }
    function prevStory(){
      if(currentIndex > 0){
        currentIndex--; runStep(); labelCurrent();
      }else{
        runStep(); // reinicia barra no primeiro
      }
    }
    function closeStoriesOverlay(){
      storiesOverlay.classList.remove("open");
      clearViewer();
      unlockBody();
    }
    tapRight.addEventListener("click", nextStory);
    tapLeft.addEventListener("click", prevStory);
    closeStories.addEventListener("click", closeStoriesOverlay);
    storiesOverlay.addEventListener("click", (e)=>{ if(e.target === storiesOverlay) closeStoriesOverlay() });

    /* =================== GRID =================== */
    const grid  = document.getElementById("grid");
    const countEl = document.getElementById("count");
    const searchTop = document.getElementById("searchTop");
    const heartTop  = document.getElementById("heartTop");
    const favCount  = document.getElementById("favCount");

    function updateFavBadge(){
      const n = FAVORITES.size;
      favCount.textContent = n;
      favCount.style.display = n ? "grid" : "none";
      heartTop.classList.toggle("active", FILTER_FAVS_ONLY);
    }

    function filteredList(){
      const q = (searchTop.value || "").trim().toLowerCase();
      let list = PRODUCTS;
      if(FILTER_FAVS_ONLY) list = list.filter(p=> isFav(p.id));
      if(q) list = list.filter(p =>
        (p.nome||"").toLowerCase().includes(q) || (p.descricao||"").toLowerCase().includes(q)
      );
      return list;
    }

    function render(){
      const list = filteredList();
      countEl.textContent = `${list.length} item(ns)`;
      grid.innerHTML = "";
      for(const p of list){
        const el = document.createElement("article");
        el.className = "card";
        el.id = p.id;
        const favActive = isFav(p.id) ? "active" : "";

        el.innerHTML = `
          <button class="fav ${favActive}" data-fav="${p.id}" title="Favoritar">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path class="fill" d="M12.1 20.3s-7.6-4.4-9.2-9.3C1.9 6.8 5 4.1 8 5.1c1.5.5 2.7 1.8 4 4 1.3-2.2 2.5-3.5 4-4 3-.9 6.1 1.7 5.1 5.9-1.5 4.9-9.1 9.3-9.1 9.3z"/></svg>
          </button>

          <img class="thumb" src="${p.foto}" alt="${p.nome}" loading="lazy" />
          <div class="content">
            <h2 class="title">${p.nome}</h2>
            <div class="price">${fmtBRL(p.preco)}</div>
            <p class="desc">${p.descricao||""}</p>
          </div>
          <span class="pill">Usado</span>
        `;
        grid.appendChild(el);
      }
      updateFavBadge();
    }

    // Toggle favoritos (card + topo)
    grid.addEventListener("click", (e)=>{
      const favBtn = e.target.closest("[data-fav]");
      if(favBtn){
        const id = favBtn.dataset.fav;
        if(FAVORITES.has(id)) FAVORITES.delete(id); else FAVORITES.add(id);
        saveFavs();
        render();
        return;
      }
    });
    heartTop.addEventListener("click", ()=>{
      FILTER_FAVS_ONLY = !FILTER_FAVS_ONLY;
      render();
    });
    searchTop.addEventListener("input", render);

    /* =================== INIT =================== */
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("today").textContent = new Date().toLocaleDateString("pt-BR", {weekday:"long", day:"2-digit", month:"2-digit"});

    (async function init(){
      try{
        await loadData();
        renderStories();
        render();
      }catch(err){
        console.error(err);
        document.querySelector("main").innerHTML = `
          <div style="padding:24px; background:var(--surface); border:1px solid var(--line); border-radius:12px">
            <h2 style="margin:0 0 8px">Não foi possível carregar os dados</h2>
            <p style="color:var(--muted)">Verifique o <b>URL_API</b> e o retorno do seu Google Apps Script (<code>?acao=listar</code>).</p>
          </div>`;
      }
    })();

    // deep-link para card
    if(location.hash){
      const el = document.querySelector(location.hash);
      if(el){ el.scrollIntoView({behavior:"smooth", block:"center"}); }
    }
  </script>
</body>
</html>
