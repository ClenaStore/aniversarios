<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel ‚Ä¢ Anivers√°rios (WhatsApp Oficial)</title>
  <meta name="description" content="Painel que l√™ planilha do Google e envia felicita√ß√µes via WhatsApp Cloud API">
  <style>
    :root{ --bg:#0f0f10; --card:#151515; --line:#2a2a2a; --text:#f6f6f6; --muted:#cfcfcf; --brand:#22c55e; --danger:#ef4444 }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text) }
    header{ padding:20px 24px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between }
    h1{ margin:0; font-size:20px }
    .wrap{ padding:20px; display:grid; gap:16px }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px; border-bottom:1px solid var(--line); font-size:14px }
    th{ text-align:left; color:var(--muted) }
    .btn{ background:var(--brand); border:0; color:#000; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; transition:transform .08s ease }
    .btn:active{ transform:scale(.98) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-outline{ background:transparent; color:var(--text); border:1px solid var(--line) }
    .chip{ padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted) }
    .ok{ color:#22c55e }.bad{ color:var(--danger) }
    input,select{ background:#0d0d0d; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px }
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(3, minmax(0,1fr)) }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr } }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
    .spin{ display:inline-block; width:14px; height:14px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; vertical-align:-2px; animation:sp .7s linear infinite }
    @keyframes sp{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <header>
    <h1>üéÇ Painel de Anivers√°rios ‚Üí WhatsApp</h1>
    <div class="toolbar">
      <button id="btnSendAll" class="btn">Enviar para todos listados</button>
      <span id="status" class="chip">Pronto</span>
    </div>
  </header>

  <div class="wrap">
    <div class="card grid">
      <label>
        Empresa
        <select id="empresa">
          <option value="">(todas)</option>
          <option>MERCATTO DELICIA</option>
          <option>MERCATTO DEL√çCIA</option>
          <option>VILLA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>PADARIA DEL√çCIA</option>
          <option>M. KIDS</option>
          <option>DELICIA GOURMET</option>
          <option>DELIC√çA GOURMET</option>
        </select>
      </label>

      <label>
        Janela de dias
        <select id="dias">
          <option value="0">Somente hoje</option>
          <option value="3">Pr√≥ximos 3 dias</option>
          <option value="7" selected>Pr√≥ximos 7 dias</option>
          <option value="14">Pr√≥ximos 14 dias</option>
        </select>
        <div class="hint">Inclui hoje</div>
      </label>

      <label>
        Link de Reserva
        <input id="linkReserva" placeholder="https://seusite.com/reserva" value="https://seusite.com/reserva" />
        <div class="hint">Use URL completa (https://...). O WhatsApp transforma em link clic√°vel.</div>
      </label>

      <label style="grid-column:1/-1">
        Mensagem (usa placeholders)
        <input id="msgTemplate" value="Ol√°, {{NOME}}! üéâ A equipe {{EMPRESA}} deseja um feliz anivers√°rio! üéÇ Reserve aqui: {{LINK}}" />
        <div class="hint">Placeholders: {{NOME}}, {{EMPRESA}}, {{LINK}}</div>
      </label>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Nome</th>
            <th>Anivers√°rio</th>
            <th>Telefone</th>
            <th>Enviado</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
// ========= CONFIG =========
const GAS_URL = "https://script.google.com/macros/s/AKfycbwqJypN425q5w6Zz-xBc00zFpPycFNfsnvElWX1sUtt16BEx6I7_1kR4hOWI2g0jKZ0bw/exec";
const WHATSAPP_ENDPOINT = "https://aniversarios-three.vercel.app/api/whatsapp/send";
// =========================

const tblBody = document.querySelector('#tbl tbody');
const statusEl = document.getElementById('status');
const empresaSel = document.getElementById('empresa');
const diasSel = document.getElementById('dias');
const btnSendAll = document.getElementById('btnSendAll');
const linkReservaEl = document.getElementById('linkReserva');
const msgTemplateEl = document.getElementById('msgTemplate');

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
function setStatus(t, cls){ statusEl.textContent = t; statusEl.className = 'chip ' + (cls||''); }
function removeAcentos(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase().trim(); }

function toDateBRorISO(v){
  if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) return v;
  if (!v) return null;
  const str = String(v).trim();
  if (/^\d{4}-\d{2}-\d{2}/.test(str) || str.includes('T')) { const d = new Date(str); return isNaN(d) ? null : d; }
  const s = str.replaceAll('-', '/'); const parts = s.split('/').map(x => x.trim());
  if (parts.length < 2) return null; let [dd, mm, yyyy] = parts;
  const d = new Date(yyyy ? +yyyy : new Date().getFullYear(), (+mm)-1, +dd);
  return isNaN(d) ? null : d;
}

function isBirthdayNextDays(d, dias){
  if (!d) return false;
  const hoje = new Date();
  const baseHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  const alvo = new Date(baseHoje.getFullYear(), d.getMonth(), d.getDate());
  if (alvo < baseHoje) alvo.setFullYear(baseHoje.getFullYear() + 1);
  const diff = (alvo - baseHoje) / (1000*60*60*24);
  return diff >= 0 && diff <= Number(dias);
}

function normPhoneBR(p){
  const digits = (p||'').replace(/\D+/g,'');
  if (!digits) return '';
  const base = digits.startsWith('55') ? digits : '55' + digits;
  return '+' + base.replace(/^(\+?55)?0+/, '55');
}

function ensureHttpUrl(u){
  const s = String(u||'').trim();
  if (!s) return '';
  return /^https?:\/\//i.test(s) ? s : ('https://' + s);
}

function buildMessage(nome, empresa, link){
  let tpl = msgTemplateEl.value || '';
  const map = {
    '{{NOME}}': nome || '',
    '{{EMPRESA}}': empresa || '',
    '{{LINK}}': link || ''
  };
  for (const [k,v] of Object.entries(map)) tpl = tpl.split(k).join(v);
  return tpl;
}

window.addEventListener('load', loadRows);
empresaSel.addEventListener('change', loadRows);
diasSel.addEventListener('change', loadRows);

btnSendAll.addEventListener('click', async () => {
  const buttons = [...document.querySelectorAll('button[data-phone]:not([disabled])')];
  if (!buttons.length){ setStatus('Nada para enviar', 'bad'); return; }
  btnSendAll.disabled = true;
  const total = buttons.length;
  let ok = 0, fail = 0;
  for (let i = 0; i < total; i++) {
    const b = buttons[i];
    setStatus(`Enviando (${i+1}/${total})‚Ä¶`);
    const sent = await sendOne(b.dataset.row, decodeURIComponent(b.dataset.name), b.dataset.phone, b.dataset.empresa, true, b);
    sent ? ok++ : fail++;
    await sleep(700);
  }
  setStatus(`Conclu√≠do: ${ok} enviado(s), ${fail} falha(s)`, fail ? 'bad' : 'ok');
  btnSendAll.disabled = false;
  loadRows();
});

async function loadRows(){
  try{
    setStatus('Carregando‚Ä¶');
    tblBody.innerHTML = '';

    const empresaParam = encodeURIComponent(empresaSel.value || '');
    const url = GAS_URL + `?days=${encodeURIComponent(diasSel.value)}${empresaSel.value ? `&empresa=${empresaParam}` : ''}`;
    const r = await fetch(url);
    let data;
    try { data = await r.json(); }
    catch { setStatus('Erro ao ler JSON do GAS', 'bad'); return; }

    const list = Array.isArray(data) ? data : (data.rows || []);

    const empresaFiltro = removeAcentos(empresaSel.value);
    const rows = list.filter(item => {
      const emp = removeAcentos(item.empresa);
      const okEmp = !empresaFiltro || emp === empresaFiltro;
      const d = toDateBRorISO(item.aniversario);
      const okDia = isBirthdayNextDays(d, Number(diasSel.value));
      return okEmp && okDia;
    });

    if (!rows.length){ setStatus(`Sem aniversariantes (pr√≥x. ${diasSel.value} dia(s))`); return; }

    for (const row of rows){
      const d = toDateBRorISO(row.aniversario);
      const phone = normPhoneBR(row.telefone);
      const sent = row.horarioEnvio ? '‚úÖ' : '‚Äî';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.empresa||''}</td>
        <td>${row.nome||''}</td>
        <td>${d ? d.toLocaleDateString('pt-BR') : (row.aniversario||'')}</td>
        <td>${phone}</td>
        <td>${sent}</td>
        <td>
          <button class="btn btn-outline"
            data-row="${row.row}"
            data-name="${encodeURIComponent(row.nome||'')}"
            data-phone="${phone}"
            data-empresa="${encodeURIComponent(row.empresa||'')}">
            Enviar
          </button>
        </td>`;
      tblBody.appendChild(tr);
    }

    [...document.querySelectorAll('button[data-phone]')].forEach(b => b.addEventListener('click', async () => {
      await sendOne(
        b.dataset.row,
        decodeURIComponent(b.dataset.name),
        b.dataset.phone,
        decodeURIComponent(b.dataset.empresa),
        false,
        b
      );
    }));

    setStatus(`${rows.length} aniversariante(s) ‚Äì pr√≥ximos ${diasSel.value} dia(s)`);
  }catch(err){
    console.error(err);
    setStatus('Erro ao carregar', 'bad');
  }
}

// ===== Envio como TEXTO (sem template), com preview do link =====
// Sem Content-Type para evitar preflight CORS
async function sendOne(row, nome, phone, empresa, silent=false, btn){
  try{
    if (!phone){ if (!silent) setStatus('Telefone vazio/ inv√°lido', 'bad'); return false; }
    const link = ensureHttpUrl(linkReservaEl.value);
    const text = buildMessage(nome, empresa, link);

    if (!silent) setStatus(`Enviando para ${nome}‚Ä¶`);
    if (btn){ btn.disabled = true; const old = btn.innerHTML; btn._old = old; btn.innerHTML = '<span class="spin"></span>'; }

    const resp = await fetch(WHATSAPP_ENDPOINT, {
      method: 'POST',
      // sem headers ‚Üí evita preflight
      body: JSON.stringify({ to: phone, text, preview_url: true })
    });

    let data = {};
    try { data = await resp.json(); } catch { data = { raw: 'non-JSON response' }; }

    if (!resp.ok){
      console.error('Erro WhatsApp ‚Üí', data);
      const upstream = data?.upstream;
      const msg =
        data?.error ||
        upstream?.error?.error_user_msg ||
        upstream?.error?.message ||
        upstream?.message ||
        `HTTP ${resp.status}`;
      if (!silent) setStatus(`Falha: ${msg}`, 'bad');
      if (btn){ btn.disabled = false; btn.innerHTML = btn._old || 'Enviar'; }
      return false;
    }

    // Marca hor√°rio na planilha (tolerante a falha)
    try {
      await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ row: Number(row), horario: new Date().toISOString() })
      });
    } catch(e) {
      console.warn('Falha ao marcar na planilha:', e);
    }

    if (btn){ btn.innerHTML = 'Enviado ‚úîÔ∏è'; }
    if (!silent) setStatus('Enviado ‚úîÔ∏è', 'ok');
    return true;
  }catch(err){
    console.error(err);
    if (!silent) setStatus(`Erro ao enviar: ${String(err)}`, 'bad');
    if (btn){ btn.disabled = false; btn.innerHTML = btn._old || 'Enviar'; }
    return false;
  }
}
</script>
</body>
</html>
