<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Painel de Anivers√°rios</title>
<style>
:root{--bg:#0b1220;--panel:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--ok:#22c55e;--warn:#f59e0b}
*{box-sizing:border-box}html,body{margin:0}
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#060a14);color:var(--text)}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:rgba(17,24,39,.9);border:1px solid var(--line);border-radius:16px;padding:16px}
.grid{display:grid;gap:12px}.cols-3{grid-template-columns:2fr 1fr 1fr}.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:6px}
input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c1322;color:#e5e7eb}
button{background:var(--ok);color:#052012;font-weight:700;cursor:pointer}
button.secondary{background:#0c1322;color:#e5e7eb}
table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px}
thead th{color:var(--muted);text-align:left;padding:8px 10px}
tbody td{padding:10px;border:1px solid var(--line);background:#0c1322}
tbody td:first-child{border-radius:12px 0 0 12px}tbody td:last-child{border-radius:0 12px 12px 0}
.badge{display:inline-block;padding:4px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:.8rem}
.small{font-size:.85rem;color:var(--muted)}
.right{display:flex;justify-content:flex-end;gap:10px}
</style>
</head>
<body>
<div class="container">
  <h1 style="margin:0 0 8px 0;font-size:1.5rem">üéâ Painel de Anivers√°rios</h1>

  <section class="card">
    <div class="grid cols-4">
      <div>
        <label>Empresa</label>
        <select id="EMPRESA"><option value="">Todas as empresas</option></select>
      </div>
      <div>
        <label>Janela m√°x. (dias)</label>
        <input id="DIAS" type="number" min="1" max="365" value="30">
      </div>
      <div>
        <label>Per√≠odo exato (dias)</label>
        <select id="IN_DAYS" multiple size="3" title="Segure Ctrl/Cmd para multi">
          <option value="10">10 dias</option>
          <option value="15">15 dias</option>
          <option value="20">20 dias</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="BTN_CARREGAR" onclick="load()">Carregar</button>
      </div>
    </div>
    <div style="margin-top:12px" class="grid cols-3">
      <div>
        <label>URL de Reserva</label>
        <input id="RESERVA_URL" placeholder="https://seu-site.com/reservas">
      </div>
      <div>
        <label>URL de Informa√ß√µes</label>
        <input id="INFO_URL" placeholder="https://seu-site.com/aniversarios">
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="secondary" onclick="toggleSelectAll()">Selecionar/limpar todos</button>
      </div>
    </div>
    <div style="margin-top:8px;display:flex;gap:10px;align-items:center">
      <span id="status" class="badge">carregando empresas‚Ä¶</span>
      <span id="progress" class="badge"></span>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:1.1rem">Pr√≥ximos Anivers√°rios</h2>
      <div class="right">
        <button onclick="sendSelected()">Enviar WhatsApp (selecionados)</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th><input type="checkbox" id="CHK_ALL" onclick="checkAll(this)"></th>
          <th>Nome</th><th>Empresa</th><th>Anivers√°rio</th><th>Faltam</th><th>Telefone</th><th>Status</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="msg" class="small" style="margin-top:8px"></div>
  </section>
</div>

<script>
/* ===== URLs ===== */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwGu3TQ89rJFpkIUWECGnWkn2Q9Qraz4OOj0a7_AdBAkcaCk12Zn0n0J-EjpViYGmASug/exec';
const VERCEL_API = 'https://aniversarios-blond.vercel.app/api/send-birthday'; // <-- ajuste se for outro dom√≠nio

/* ===== JSONP util (sem CORS) ===== */
function jsonp(url, params = {}, timeoutMs = 15000) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const qs = new URLSearchParams({ ...params, callback: cb }).toString();
    const script = document.createElement('script');
    const timer = setTimeout(() => cleanup(new Error('timeout')), timeoutMs);
    function cleanup(err){ clearTimeout(timer); delete window[cb]; if(script.parentNode) script.parentNode.removeChild(script); err && reject(err); }
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    script.src = `${url}?${qs}`;
    script.onerror = ()=>cleanup(new Error('network_error'));
    document.body.appendChild(script);
  });
}

const $ = id => document.getElementById(id);
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function setStatus(t){ $('status').textContent = t; }
let rowsGlobal = [];

async function loadCompanies(){
  setStatus('carregando empresas‚Ä¶'); $('msg').textContent='';
  try{
    const resp = await jsonp(GAS_URL, { action:'companies' });
    if (!resp || resp.ok === false) throw new Error(resp?.error || 'erro');
    const sel = $('EMPRESA'); sel.innerHTML = '<option value="">Todas as empresas</option>';
    (resp.empresas || []).forEach(emp => {
      const opt = document.createElement('option'); opt.value = emp; opt.textContent = emp; sel.appendChild(opt);
    });
    setStatus('empresas carregadas');
  }catch(e){ setStatus('erro ao carregar empresas'); $('msg').textContent = 'Falha ao buscar empresas: ' + e.message; }
}

function getInDaysParam(){
  const opts = Array.from($('IN_DAYS').selectedOptions).map(o=>o.value);
  return opts.length ? opts.join(',') : '';
}

/* Busca e renderiza */
async function load(){
  const empresa = $('EMPRESA').value.trim();
  const dias = Number($('DIAS').value || 30);
  const inDays = getInDaysParam();

  setStatus('carregando anivers√°rios‚Ä¶'); $('msg').textContent='';

  try{
    const params = { action:'list', days:String(dias) };
    if (empresa) params.empresa = empresa;
    if (inDays) params.in = inDays;

    const resp = await jsonp(GAS_URL, params);
    if (!resp || resp.ok === false) throw new Error(resp?.error || 'erro');
    rowsGlobal = resp.data || [];
    render(rowsGlobal);
    setStatus('pronto');
  }catch(e){
    setStatus('erro');
    $('msg').textContent = 'Falha ao carregar: ' + e.message;
  }
}

function render(rows){
  const tb = $('tbody'); tb.innerHTML='';
  $('progress').textContent = `${rows.length} registro(s)`;
  if (!rows.length) { $('msg').textContent='Nenhum registro na sele√ß√£o.'; return; }
  rows.forEach((item, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="rowchk" data-idx="${idx}" checked></td>
      <td>${esc(item.nome)}</td>
      <td>${esc(item.empresa||'')}</td>
      <td>${esc(item.aniversario)}</td>
      <td>${item.dias}</td>
      <td>${esc(formatPhone(item.phoneE164 || item.phoneRaw || ''))}</td>
      <td id="st_${idx}" class="small"></td>`;
    tb.appendChild(tr);
  });
}

function formatPhone(n){ return n.replace(/^55/,'+55 ').replace(/(\d{2})(\d{5})(\d{4})$/,'($1) $2-$3'); }

function checkAll(master){
  document.querySelectorAll('.rowchk').forEach(c => c.checked = master.checked);
}
function toggleSelectAll(){
  const boxes = Array.from(document.querySelectorAll('.rowchk'));
  const anyUnchecked = boxes.some(b=>!b.checked);
  boxes.forEach(b=> b.checked = anyUnchecked);
}

/* Envio em massa via Vercel */
async function sendSelected(){
  const reservaUrl = $('RESERVA_URL').value.trim();
  const infoUrl = $('INFO_URL').value.trim();
  const selectedIdx = Array.from(document.querySelectorAll('.rowchk'))
    .filter(c => c.checked)
    .map(c => Number(c.getAttribute('data-idx')));

  if (!selectedIdx.length) { alert('Selecione pelo menos um contato.'); return; }

  let ok = 0, fail = 0;
  for (const i of selectedIdx){
    const r = rowsGlobal[i];
    const el = $('st_'+i);
    el.textContent = 'enviando‚Ä¶';
    try{
      const body = { to: r.phoneE164 || r.phoneRaw, name: r.nome, reservaUrl, infoUrl };
      const resp = await fetch(VERCEL_API, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body),
      });
      const json = await resp.json().catch(()=> ({}));
      if (!resp.ok) throw new Error(json?.error || ('HTTP '+resp.status));
      el.textContent = '‚úÖ enviado';
      ok++;
    }catch(e){
      el.textContent = '‚ùå ' + (e?.message || 'erro');
      fail++;
    }
    // pequeno intervalo para n√£o saturar
    await new Promise(res=>setTimeout(res, 350));
  }
  $('msg').textContent = `Conclu√≠do: ${ok} enviados, ${fail} falhas.`;
}

/* boot */
document.addEventListener('DOMContentLoaded', loadCompanies);
</script>
</body>
</html>
