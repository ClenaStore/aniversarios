<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel ‚Ä¢ Anivers√°rios (WhatsApp Oficial)</title>
  <style>
    :root{ --bg:#0f0f10; --card:#151515; --line:#2a2a2a; --text:#f6f6f6; --muted:#cfcfcf; --brand:#22c55e; --danger:#ef4444 }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text) }
    header{ padding:20px 24px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between }
    h1{ margin:0; font-size:20px }
    .wrap{ padding:20px; display:grid; gap:16px }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px; border-bottom:1px solid var(--line); font-size:14px }
    th{ text-align:left; color:var(--muted) }
    .btn{ background:var(--brand); border:0; color:#000; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600 }
    .btn-outline{ background:transparent; color:var(--text); border:1px solid var(--line) }
    .chip{ padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted) }
    .ok{ color:#22c55e }
    .bad{ color:var(--danger) }
    input,select{ background:#0d0d0d; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px }
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr)) }
    @media (max-width:800px){ .grid{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header>
    <h1>üéÇ Painel de Anivers√°rios ‚Üí WhatsApp</h1>
    <div class="toolbar">
      <button id="btnSendAll" class="btn">Enviar para todos de hoje</button>
      <span id="status" class="chip">Pronto</span>
    </div>
  </header>
  <div class="wrap">
    <div class="card grid">
      <label>
        Empresa
        <select id="empresa">
          <option value="">(todas)</option>
          <option>MERCATTO DELICIA</option>
          <option>VILLA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>M. KIDS</option>
          <option>DELICIA GOURMET</option>
        </select>
      </label>
      <label style="grid-column:1/-1">
        Mensagem (texto simples)
        <input id="msgTemplate" value="Ol√°, {{NOME}}! Parab√©ns pelo seu anivers√°rio üéâ A equipe Mercatto deseja muitas felicidades!" />
      </label>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Nome</th>
            <th>Anivers√°rio</th>
            <th>Telefone</th>
            <th>Enviado</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const tblBody = document.querySelector('#tbl tbody');
const statusEl = document.getElementById('status');
const empresaSel = document.getElementById('empresa');
const msgTemplateInput = document.getElementById('msgTemplate');
const btnSendAll = document.getElementById('btnSendAll');

// üîó SUA URL DO GAS FIXA
const GAS_URL = "https://script.google.com/macros/s/AKfycbwiqz02bO-t0kuoJ7LpLOaiXbGzcBgkMHe5jkcCFd8vTEydI_54vDZEqlVFJiT2IgqW8A/exec";

window.addEventListener('load', () => {
  loadRows();
});
empresaSel.addEventListener('change', loadRows);
msgTemplateInput.addEventListener('change', loadRows);

btnSendAll.addEventListener('click', async () => {
  const buttons = [...document.querySelectorAll('button[data-phone]')];
  for (const b of buttons) {
    await sendOne(b.dataset.row, b.dataset.name, b.dataset.phone);
    await sleep(700); // evita rate-limit
  }
});

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function setStatus(t, cls){ statusEl.textContent = t; statusEl.className = 'chip ' + (cls||''); }

function parseDateBrazil(d){
  if (!d) return null;
  const s = String(d).replaceAll('-', '/');
  const parts = s.split('/').map(x => x.trim());
  if (parts.length < 2) return null;
  let [dd, mm, yyyy] = parts;
  if (dd.length <= 2 && mm.length <= 2 && (!yyyy || yyyy.length === 4)) {
    const day = parseInt(dd, 10);
    const mon = parseInt(mm, 10) - 1;
    const year = yyyy ? parseInt(yyyy, 10) : new Date().getFullYear();
    const date = new Date(year, mon, day);
    return isNaN(date) ? null : date;
  }
  return null;
}

function isBirthdayToday(d){
  if (!d) return false;
  const today = new Date();
  return d.getDate() === today.getDate() && d.getMonth() === today.getMonth();
}

function normPhoneBR(p){
  const digits = (p||'').replace(/\D+/g,'');
  let num = digits;
  if (num.startsWith('55')) num = num;
  else num = '55' + num;
  return '+' + num;
}

async function loadRows(){
  try{
    setStatus('Carregando‚Ä¶');
    tblBody.innerHTML = '';

    const r = await fetch(GAS_URL);
    const data = await r.json();

    const rows = (data.rows||[]).filter(r => {
      const okEmp = !empresaSel.value || String(r.empresa).toUpperCase() === empresaSel.value;
      const d = parseDateBrazil(r.aniversario);
      return okEmp && isBirthdayToday(d);
    });

    if (!rows.length){ setStatus('Sem aniversariantes hoje'); return; }

    for (const row of rows){
      const d = parseDateBrazil(row.aniversario);
      const phone = normPhoneBR(row.telefone);
      const sent = row.horarioEnvio ? '‚úÖ' : '‚Äî';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.empresa||''}</td>
        <td>${row.nome||''}</td>
        <td>${d ? d.toLocaleDateString('pt-BR') : (row.aniversario||'')}</td>
        <td>${phone}</td>
        <td>${sent}</td>
        <td>
          <button class="btn btn-outline" data-row="${row.row}" data-name="${encodeURIComponent(row.nome||'')}" data-phone="${phone}">Enviar</button>
        </td>`;
      tblBody.appendChild(tr);
    }

    [...document.querySelectorAll('button[data-phone]')].forEach(b => b.addEventListener('click', async () => {
      await sendOne(b.dataset.row, decodeURIComponent(b.dataset.name), b.dataset.phone);
    }));

    setStatus(`${rows.length} aniversariante(s) encontrado(s)`);
  }catch(err){
    console.error(err);
    setStatus('Erro ao carregar', 'bad');
  }
}

async function sendOne(row, nome, phone){
  try{
    setStatus(`Enviando para ${nome}‚Ä¶`);
    const text = msgTemplateInput.value.replace('{{NOME}}', nome);

    // Envio via Vercel
    const r = await fetch('/api/whatsapp/send', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ to: phone, text })
    });
    const data = await r.json();
    if (!r.ok){
      console.error(data);
      setStatus('Falha no envio', 'bad');
      return;
    }

    // Atualizar planilha com hor√°rio
    await fetch(GAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ row: Number(row), horario: new Date().toISOString() })
    });

    setStatus('Enviado ‚úîÔ∏è', 'ok');
    loadRows();
  }catch(err){
    console.error(err);
    setStatus('Erro ao enviar', 'bad');
  }
}
</script>
</body>
</html>
