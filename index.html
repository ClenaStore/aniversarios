<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Bazar Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial, sans-serif;background:#fafafa;margin:0;color:#111}

    /* Header Instagram */
    header{display:flex;justify-content:center;align-items:center;padding:12px;background:#fff;border-bottom:1px solid #ddd;font-family:'Billabong',cursive;font-size:28px}
    header span{font-family:inherit}

    /* Stories */
    .stories{display:flex;gap:14px;padding:12px;overflow-x:auto;background:#fff;border-bottom:1px solid #ddd}
    .story{width:70px;height:70px;border-radius:50%;overflow:hidden;border:3px solid #ff0066;flex:0 0 auto;display:flex;align-items:center;justify-content:center;background:#fff}
    .story img{width:100%;height:100%;object-fit:cover;border-radius:50%}

    /* Feed */
    .feed{padding:10px}
    .post{background:#fff;margin-bottom:20px;border:1px solid #ddd;border-radius:6px;overflow:hidden}
    .post-header{display:flex;align-items:center;gap:8px;padding:10px}
    .post-header img{width:32px;height:32px;border-radius:50%}
    .post-header span{font-weight:600;font-size:14px}
    .post-img{position:relative}
    .post-img img{width:100%;max-height:400px;object-fit:cover;display:block}
    .flag{position:absolute;top:10px;right:10px;background:#16a34a;color:#fff;padding:4px 8px;font-size:12px;border-radius:12px}
    .post-body{padding:10px}
    .price{color:#16a34a;font-weight:bold;margin:4px 0}
    .btn{background:#16a34a;color:#fff;padding:6px 10px;border-radius:6px;text-decoration:none;display:inline-block;margin-top:8px;font-size:13px;cursor:pointer}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:100}
    .modal.active{display:flex}
    .modal-content{background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 6px 20px rgba(0,0,0,.3);position:relative}
    .modal-content img{width:100%;border-radius:8px;margin-bottom:12px}
    .modal-content h2{margin:0;font-size:18px}
    .modal-content .price{color:#16a34a;font-weight:bold;margin:8px 0}
    .close{position:absolute;top:10px;right:14px;font-size:20px;cursor:pointer;color:#333}
  </style>
</head>
<body>
  <header><span>Instagram</span></header>

  <section class="stories" id="stories"></section>

  <main id="feed" class="feed"></main>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <img id="mFoto" src="">
      <h2 id="mNome"></h2>
      <div id="mPreco" class="price"></div>
      <p id="mDesc"></p>
      <a id="mWhats" class="btn" target="_blank">Falar no WhatsApp</a>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyVUcV4Z9x3tQZy4z0SDg37lTCy0aHcjoyOeVQsQU4ClJxrMQhxYEwwLqATWGK27Wv4aQ/exec"; // coloque aqui a URL publicada do GAS

    fetch(API_URL)
      .then(r=>r.json())
      .then(data=>{
        // STORIES = lojas
        const storiesDiv = document.getElementById("stories");
        data.lojas.forEach(loja=>{
          if(loja.perfil_foto){
            const div=document.createElement("div");
            div.className="story";
            div.innerHTML=`<img src="${loja.perfil_foto}" title="${loja.nome}">`;
            storiesDiv.appendChild(div);
          }
        });

        // Feed com produtos (sem vendidos e intercalando lojas)
        let produtos = data.produtos.filter(p=> (p.status||"").toLowerCase()!=="vendido");
        produtos.sort((a,b)=> new Date(b.datahora)-new Date(a.datahora));

        // Intercalar: não deixar 2 produtos seguidos da mesma loja
        let feedList=[];
        let lojasUsadas=new Set();
        while(produtos.length){
          for(let i=0;i<produtos.length;i++){
            if(!lojasUsadas.has(produtos[i].loja)){
              feedList.push(produtos[i]);
              lojasUsadas.add(produtos[i].loja);
              produtos.splice(i,1);
              break;
            }
          }
          if(lojasUsadas.size>=data.lojas.length) lojasUsadas.clear();
        }

        const feed = document.getElementById("feed");
        feedList.forEach(p=>{
          const loja = data.lojas.find(l=>l.id_loja===p.loja);
          const div=document.createElement("div");
          div.className="post";
          div.innerHTML=`
            <div class="post-header">
              <img src="${loja.perfil_foto}">
              <span>${loja.nome}</span>
            </div>
            <div class="post-img">
              <img src="${p.foto}" alt="${p.nome}">
              <div class="flag">${p.flag}</div>
            </div>
            <div class="post-body">
              <p>${p.descricao}</p>
              <div class="price">R$ ${Number(p.preco).toFixed(2)}</div>
            </div>
          `;
          const btn = document.createElement("a");
          btn.className="btn";
          btn.textContent="Detalhes";
          btn.onclick = ()=>openModal(p);
          div.querySelector(".post-body").appendChild(btn);
          feed.appendChild(div);
        });
      });

    function openModal(p){
      document.getElementById("mFoto").src=p.foto;
      document.getElementById("mNome").textContent=p.nome;
      document.getElementById("mPreco").textContent="R$ "+Number(p.preco).toFixed(2);
      document.getElementById("mDesc").textContent=p.descricao;
      const msg=`Olá! Tenho interesse neste produto: ${p.nome} - R$ ${p.preco}`;
      document.getElementById("mWhats").href=`https://wa.me/${p.whatsapp}?text=${encodeURIComponent(msg)}`;
      document.getElementById("modal").classList.add("active");
    }
    function closeModal(){ document.getElementById("modal").classList.remove("active"); }
  </script>
</body>
</html>
