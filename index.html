<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel ‚Ä¢ Anivers√°rios (WhatsApp Manual)</title>
  <meta name="description" content="Painel que l√™ planilha do Google e prepara mensagens no WhatsApp para envio manual">
  <style>
    :root{ --bg:#0f0f10; --card:#151515; --line:#2a2a2a; --text:#f6f6f6; --muted:#cfcfcf; --brand:#22c55e; --danger:#ef4444; --warn:#f59e0b }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--text) }
    header{ padding:20px 24px; border-bottom:1px solid var(--line); display:flex; gap:12px; align-items:center; justify-content:space-between }
    h1{ margin:0; font-size:20px }
    .wrap{ padding:20px; display:grid; gap:16px }
    .toolbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px; border-bottom:1px solid var(--line); font-size:14px; vertical-align:middle }
    th{ text-align:left; color:var(--muted) }
    .btn{ background:var(--brand); border:0; color:#000; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; transition:transform .08s ease }
    .btn:active{ transform:scale(.98) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-outline{ background:transparent; color:var(--text); border:1px solid var(--line) }
    .chip{ padding:4px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted) }
    .ok{ color:#22c55e }.bad{ color:var(--danger) }.warn{ color:var(--warn) }
    input,select,textarea{ background:#0d0d0d; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px }
    textarea{ min-height:128px; resize:vertical; line-height:1.35 }
    .grid{ display:grid; gap:12px; grid-template-columns:repeat(3, minmax(0,1fr)) }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }
    .hint{ font-size:12px; color:var(--muted); margin-top:6px }
    .row-actions{ display:flex; gap:8px; align-items:center; }
    .small{ font-size:12px; color:var(--muted) }
    .invalid{ color:var(--danger); font-weight:600 }
    .tag{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; margin-left:6px }
    .tag-auto9{ border-color:var(--warn); color:var(--warn) }
  </style>
</head>
<body>
  <header>
    <h1>üéÇ Painel de Anivers√°rios ‚Üí WhatsApp (envio manual)</h1>
    <div class="toolbar">
      <button id="btnSendAll" class="btn">Abrir WhatsApp para todos</button>
      <label class="small" style="display:flex;gap:8px;align-items:center;">
        <input id="chkMarkSent" type="checkbox" checked />
        Marcar como enviado ao abrir
      </label>
      <span id="status" class="chip">Pronto</span>
    </div>
  </header>

  <div class="wrap">
    <div class="card grid">
      <label>
        Empresa
        <select id="empresa">
          <option value="">(todas)</option>
          <option>MERCATTO DELICIA</option>
          <option>MERCATTO DEL√çCIA</option>
          <option>VILLA GOURMET</option>
          <option>PADARIA DELICIA</option>
          <option>PADARIA DEL√çCIA</option>
          <option>M. KIDS</option>
          <option>DELICIA GOURMET</option>
          <option>DELIC√çA GOURMET</option>
        </select>
      </label>

      <label>
        Janela de dias
        <select id="dias">
          <option value="0">Somente hoje</option>
          <option value="3">Pr√≥ximos 3 dias</option>
          <option value="7" selected>Pr√≥ximos 7 dias</option>
          <option value="14">Pr√≥ximos 14 dias</option>
        </select>
        <div class="hint">Inclui hoje</div>
      </label>

      <label>
        Link de Reserva
        <input id="linkReserva" placeholder="https://seusite.com/reserva" value="https://seusite.com/reserva" />
        <div class="hint">URL completa (https://...)</div>
      </label>

      <label>
        WhatsApp do Restaurante (n¬∫ ou URL)
        <input id="linkWhats" placeholder="https://wa.me/55DDDNUMERO" value="https://wa.me/5599999999999" />
        <div class="hint">Cole a URL wa.me / api.whatsapp.com ou s√≥ o n√∫mero (com DDD)</div>
      </label>

      <label>
        URL da Foto (jpg/png)
        <input id="linkFoto" placeholder="https://seusite.com/imagens/banner-aniversario.jpg" />
        <div class="hint">O WhatsApp faz preview do link; anexar automaticamente n√£o √© poss√≠vel via link.</div>
      </label>

      <label style="grid-column:1/-1">
        Mensagem (placeholders)
        <textarea id="msgTemplate">{{LINK_IMAGEM}}

Ol√°, {{NOME}}! üéâ
A equipe {{EMPRESA}} deseja um feliz anivers√°rio! üéÇ

üëâ Reserve sua mesa: {{LINK_RESERVA}}
üí¨ Falar com atendente: {{LINK_ATENDENTE}}
        </textarea>
        <div class="hint">Placeholders: {{NOME}}, {{EMPRESA}}, {{LINK_RESERVA}}, {{LINK_ATENDENTE}}, {{LINK_WHATSAPP}}, {{LINK_IMAGEM}}, {{LINK}} (alias para {{LINK_RESERVA}})</div>
      </label>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>Nome</th>
            <th>Anivers√°rio</th>
            <th>Telefone</th>
            <th>Enviado</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwqJypN425q5w6Zz-xBc00zFpPycFNfsnvElWX1sUtt16BEx6I7_1kR4hOWI2g0jKZ0bw/exec";

const tblBody = document.querySelector('#tbl tbody');
const statusEl = document.getElementById('status');
const empresaSel = document.getElementById('empresa');
const diasSel = document.getElementById('dias');
const btnSendAll = document.getElementById('btnSendAll');
const linkReservaEl = document.getElementById('linkReserva');
const linkWhatsEl = document.getElementById('linkWhats');
const linkFotoEl   = document.getElementById('linkFoto');
const msgTemplateEl = document.getElementById('msgTemplate');
const chkMarkSent = document.getElementById('chkMarkSent');

function setStatus(t, cls){ statusEl.textContent = t; statusEl.className = 'chip ' + (cls||''); }
function removeAcentos(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase().trim(); }

function toDateBRorISO(v){
  if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) return v;
  if (!v) return null;
  const str = String(v).trim();
  if (/^\d{4}-\d{2}-\d{2}/.test(str) || str.includes('T')) { const d = new Date(str); return isNaN(d) ? null : d; }
  const s = str.replaceAll('-', '/'); const parts = s.split('/').map(x => x.trim());
  if (parts.length < 2) return null; let [dd, mm, yyyy] = parts;
  const d = new Date(yyyy ? +yyyy : new Date().getFullYear(), (+mm)-1, +dd);
  return isNaN(d) ? null : d;
}

function isBirthdayNextDays(d, dias){
  if (!d) return false;
  const hoje = new Date();
  const baseHoje = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
  const alvo = new Date(baseHoje.getFullYear(), d.getMonth(), d.getDate());
  if (alvo < baseHoje) alvo.setFullYear(baseHoje.getFullYear() + 1);
  const diff = (alvo - baseHoje) / (1000*60*60*24);
  return diff >= 0 && diff <= Number(dias);
}

// Normaliza n√∫mero BR
function normalizePhoneBR(p){
  let raw = String(p||'').replace(/\D+/g,'');
  if (!raw) return {digits:'', valid:false};
  raw = raw.replace(/^0+/, '');
  if (!raw.startsWith('55') && raw.length>=10) raw = '55' + raw;
  if (raw.length===12){ // fixo 8 d√≠gitos -> adiciona 9
    const ddd=raw.substring(2,4), local=raw.substring(4);
    raw = '55'+ddd+'9'+local;
  }
  return {digits:raw, valid:(raw.length>=12)};
}

function ensureHttpUrl(u){
  const s=String(u||'').trim();
  return s ? (/^https?:\/\//i.test(s)?s:'https://'+s) : '';
}

// Mant√©m o que voc√™ digitar (wa.me/api.whatsapp.com ou n√∫mero)
function ensureWhatsAppLink(v){
  let s = String(v||'').trim();
  if (!s) return '';
  if (/^https?:\/\//i.test(s)) return s;
  return 'https://wa.me/'+s.replace(/\D+/g,'');
}

// Constr√≥i link direto para falar com atendente com mensagem padr√£o
function buildAttendantDeepLink(baseWhatsInput){
  const base = ensureWhatsAppLink(baseWhatsInput);
  const msg = 'Ol√°! Gostaria de falar com um atendente sobre reserva.';
  const join = base.includes('?') ? '&' : '?';
  return base ? (base + join + 'text=' + encodeURIComponent(msg)) : '';
}

// --- Mensagem ---
function buildMessage(nome, empresa, linkReserva, linkWhats, linkAtendente, linkImagem){
  let tpl = msgTemplateEl.value || '';
  const map = {
    '{{NOME}}': nome || '',
    '{{EMPRESA}}': empresa || '',
    '{{LINK_RESERVA}}': linkReserva || '',
    '{{LINK_WHATSAPP}}': linkWhats || '',
    '{{LINK_ATENDENTE}}': linkAtendente || linkWhats || '',
    '{{LINK_IMAGEM}}': linkImagem || '',
    '{{LINK}}': linkReserva || ''
  };
  for (const [k,v] of Object.entries(map)) tpl = tpl.split(k).join(v);
  return tpl.replace(/\r\n|\r/g,'\n').replace(/[ \t]+\n/g,'\n').trim();
}

// Deep link usando api.whatsapp.com
function buildWhatsDeepLink(phoneDigits, text){
  const params = new URLSearchParams({
    phone: phoneDigits,
    text: text,
    type: 'phone_number',
    app_absent: '0'
  });
  return `https://api.whatsapp.com/send?${params.toString()}`;
}

window.addEventListener('load', loadRows);
empresaSel.addEventListener('change', loadRows);
diasSel.addEventListener('change', loadRows);

btnSendAll.addEventListener('click', async ()=>{
  const buttons=[...document.querySelectorAll('button[data-phone]:not([disabled])')];
  if (!buttons.length){ setStatus('Nada para abrir','bad'); return;}
  for (const b of buttons){
    await openOne(b.dataset.row, decodeURIComponent(b.dataset.name), b.dataset.phone, decodeURIComponent(b.dataset.empresa), b);
  }
});

async function loadRows(){
  try{
    setStatus('Carregando‚Ä¶');
    tblBody.innerHTML='';
    const empresaParam=encodeURIComponent(empresaSel.value||'');
    const url=GAS_URL+`?days=${encodeURIComponent(diasSel.value)}${empresaSel.value?`&empresa=${empresaParam}`:''}`;
    const r=await fetch(url);
    let data; try{ data=await r.json(); }catch{ setStatus('Erro ao ler JSON do GAS','bad'); return; }
    const list=Array.isArray(data)?data:(data.rows||[]);
    const empresaFiltro=removeAcentos(empresaSel.value);
    const rows=list.filter(item=>{
      const emp=removeAcentos(item.empresa); const okEmp=!empresaFiltro||emp===empresaFiltro;
      const d=toDateBRorISO(item.aniversario); const okDia=isBirthdayNextDays(d,Number(diasSel.value));
      return okEmp&&okDia;
    });
    if (!rows.length){ setStatus(`Sem aniversariantes`); return;}

    for (const row of rows){
      const d=toDateBRorISO(row.aniversario);
      const norm=normalizePhoneBR(row.telefone);
      const phoneDigits=norm.digits; const valid=norm.valid;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${row.empresa||''}</td>
        <td>${row.nome||''}</td>
        <td>${d?d.toLocaleDateString('pt-BR'):(row.aniversario||'')}</td>
        <td>${valid?('+'+phoneDigits):'<span class="invalid">inv√°lido</span>'}</td>
        <td>${row.horarioEnvio?'‚úÖ':'‚Äî'}</td>
        <td><button class="btn btn-outline" ${valid?'':'disabled'}
          data-row="${row.row}" data-name="${encodeURIComponent(row.nome||'')}"
          data-phone="${phoneDigits}" data-empresa="${encodeURIComponent(row.empresa||'')}">
          Abrir WhatsApp</button></td>`;
      tblBody.appendChild(tr);
    }

    [...document.querySelectorAll('button[data-phone]')].forEach(b=>b.addEventListener('click', async()=>{
      await openOne(b.dataset.row, decodeURIComponent(b.dataset.name), b.dataset.phone, decodeURIComponent(b.dataset.empresa), b);
    }));

    setStatus(`${rows.length} aniversariante(s)`);
  }catch(err){ console.error(err); setStatus('Erro','bad'); }
}

async function openOne(row,nome,phoneDigits,empresa,btn){
  const norm=normalizePhoneBR(phoneDigits);
  if (!norm.valid){ setStatus('Telefone inv√°lido','bad'); return false; }

  const linkReserva = ensureHttpUrl(linkReservaEl.value);
  const linkWhats   = ensureWhatsAppLink(linkWhatsEl.value);
  const linkAtendente = buildAttendantDeepLink(linkWhatsEl.value);
  const linkImagem = ensureHttpUrl(linkFotoEl.value);
  const text        = buildMessage(nome, empresa, linkReserva, linkWhats, linkAtendente, linkImagem);

  // Observa√ß√£o: via deeplink n√£o √© poss√≠vel anexar m√≠dia automaticamente;
  // colocar o link da imagem na primeira linha faz o WhatsApp gerar o preview.
  location.href = buildWhatsDeepLink(norm.digits, text);

  if (chkMarkSent.checked){
    try{
      await fetch(GAS_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({row:Number(row),horario:new Date().toISOString()})
      });
    }catch(e){}
  }

  if (btn){ btn.textContent='Aberto ‚úîÔ∏è'; btn.disabled=true; }
  setStatus('WhatsApp aberto ‚úÖ','ok');
}
</script>
</body>
</html>
